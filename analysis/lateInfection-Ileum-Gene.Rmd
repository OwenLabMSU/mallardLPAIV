---
title: "Late stage infection - Ileum - Gene"
author: "Jared J. Homola"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
This is an analysis of differential expression at the gene level between shedding rate groupings based on average shedding rates for infected mallard ileum samples.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
## Load packages and data
library(limma)
library(edgeR)
library(Glimma)
library(gplots)
library(ggrepel)
library(RColorBrewer)
library(gridExtra)
library(kableExtra)
library(org.Gg.eg.db)
library(tidyverse)

## Load data
cnt1 <- read_delim("G:/Shared drives/RNA Seq Supershedder Project/MALL DE manuscript/ileumCounts.txt", delim = "\t") %>% distinct(gene, .keep_all = TRUE)
covars <- read_delim("G:/Shared drives/RNA Seq Supershedder Project/MALL DE manuscript/MALL70_SSgroup_RAW_7.7.20.csv", delim = ",")
annot <- read_delim("G:/Shared drives/RNA Seq Supershedder Project/MALL DE manuscript/annotationGenesIleum110120.txt", delim = "\t")
```

### Prep data for analysis
```{r, warning = FALSE, message = FALSE}
cnt <- cnt1 %>%
  as_tibble() %>%
  select(-gene)

newNames.ileum <- names(cnt) %>%
  as_tibble() %>%
  mutate(value = gsub("Iluem_", "", .$value)) %>% 
  separate(value, into = c(NA, "pt1", "pt2")) %>%
  mutate(pt1 = na_if(pt1, "MALL"),
         pt2 = na_if(pt2, "ileum")) %>%
  mutate(bird = ifelse(is.na(pt1), pt2, pt1)) %>%
  mutate(bird = as.numeric(bird),
    bird = formatC(bird, width = 2, format = "d", flag = "0")) %>%
  mutate(newName = paste0("ileum_", bird))

colnames(cnt) <- newNames.ileum$newName

cnt <- cnt[,order(colnames(cnt))] %>%
  mutate(gene = cnt1$gene) %>%
  column_to_rownames("gene") %>%
  as_tibble(rownames = NA)

### Covars
covars <- covars %>%
  mutate(bird = as.numeric(bird)) %>%
  mutate(bird = formatC(bird, width = 2, format = "d", flag = "0")) %>%
  arrange(bird) %>%
  mutate(bird = as.factor(bird)) %>%
  mutate(group = str_remove(group, "-"))

covars.ileum <- covars %>%
  filter(bird %in% newNames.ileum$bird)

cnt <- cnt %>% select(-ileum_01, -ileum_72)

covars.ileum <- covars.ileum %>% filter(bird != "01",
                                        bird != "72")
```

### Prep data for analysis
Here we standardize expression levels across samples of varying depth by using the counts per million (CPM) and trimmed mean of M-values (TMM) methods. We also remove any genes that are expressed at few than 0.5 CPM in at least 25% of individuals.
```{r, warning = FALSE, message = FALSE}
#Convert to DGEList object
dge <- DGEList(counts=cnt)
dge$genes <- annot[match(rownames(dge$counts), annot$ensembl_gene_id),]

#CPM and log-CPM
cpm <- cpm(dge)
lcpm <- cpm(dge, log = TRUE)

#### Retain only genes expressed at >0.5 CPM in at least 25% of individuals
table(rowSums(dge$counts==0) == length(cnt[1,]))
keep.exprs <- rowSums(cpm>0.5) >= length(cnt[1,])/4
sum(keep.exprs)

dge <- dge[keep.exprs,, keep.lib.sizes=FALSE]
table(rowSums(dge$counts==0) == length(cnt[1,]))
dim(dge)

#TMM normalization
dge <- calcNormFactors(dge, method = "TMM")
```


### Subset data
Following normalization, we subset the data based on infection groups.
```{r, warning = FALSE, message = FALSE}
#Assign groups in DGElist
group <- recode(covars.ileum$group, C1 = "Ctl", C29 = "Ctl") %>% 
  as.factor()
dge$samples$group <- group

### Divide out I1 and I3
dge.I5 <- dge[,grep('\\bI5\\b', dge$samples$group)]

covars.I5 <- covars.ileum %>% filter(group == "I5")
```

# Differential expression analysis
```{r, warning = FALSE, message = FALSE,}
## Establish design matrix: I5
design.I5 = model.matrix(~ 0 +
                        factor(covars.I5$SSgroup.virus.sac) +
                        covars.I5$age +
                        covars.I5$sex + 
                        covars.I5$wt_55 + 
                        covars.I5$Bursa_pool)

colnames(design.I5) <- c("HIGH", "LOW", "MODERATE",
                         "age", "sexM", "weight", "poolMSU2",
                         "poolMSU3", "poolMSU4", "poolMSU5")


contr.matrix.I5 = makeContrasts(
  LvM = LOW - MODERATE,
  MvH = MODERATE - HIGH,
  LvH = LOW - HIGH,
  levels = colnames(design.I5))

## Mean-variance trend plots
v.I5 <- voomWithQualityWeights(dge.I5, design.I5, plot = FALSE)

#Fitting models
vfit.I5 <- lmFit(v.I5, design.I5) 
vfit.I5 <- contrasts.fit(vfit.I5, contrasts = contr.matrix.I5)
tfit.I5 <- treat(vfit.I5, lfc = 1.0)

## Identify DE genes
dt.I5 <- decideTests(tfit.I5, p.value = 0.1, adjust.method = "fdr")
dt.tib.I5 <- as_tibble(dt.I5, rownames = NA) %>% 
  rownames_to_column("gene") %>% 
  mutate_at(vars(starts_with("L")), as.numeric) %>% 
  mutate_at(vars(starts_with("M")), as.numeric) %>% 
  rename(LvM.I5 = LvM,
         MvH.I5 = MvH,
         LvH.I5 = LvH)

dt.tib <- dt.tib.I5 %>% 
  mutate_at(vars(starts_with("L")), as.numeric) %>% 
  mutate_at(vars(starts_with("M")), as.numeric) %>% 
  filter_at(vars(LvM.I5:LvH.I5), any_vars(. != 0))
```

### Numbers of DE genes
```{r}
allResults <- as.data.frame(summary(dt.I5)) %>% 
  filter(Var1 != "NotSig")

kable(allResults) %>%
  kable_styling("striped", full_width = F)
```

### Volcano plot
```{r, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 10, fig.align = "center"}
tmp1 <- topTreat(tfit.I5, coef = 1, n = Inf)
results1 <- mutate(tmp1, sig=ifelse(tmp1$adj.P.Val<0.1, "Sig", "Not Sig"))
p1 <- ggplot(results1, aes(logFC, -log10(P.Value))) +
  geom_point(aes(col = sig)) +
  scale_color_manual(values=c("black", "red")) +
  ggtitle("Low vs. Moderate shedding") +
  ylab("-Log10(p-value)") +
  xlab("Log(Fold count)") +
  theme_bw() +
  theme(legend.position = "none")


tmp2 <- topTreat(tfit.I5, coef = 2, n = Inf)
results2 <- mutate(tmp2, sig=ifelse(tmp2$adj.P.Val<0.1, "Sig", "Not Sig"))
p2 <- ggplot(results2, aes(logFC, -log10(P.Value))) +
  geom_point(aes(col = sig)) +
  scale_color_manual(values=c("black", "red")) +
  ggtitle("Moderate vs. High shedding") +
  ylab("-Log10(p-value)") +
  xlab("Log(Fold count)") +
  theme_bw() +
  theme(legend.position = "none")

tmp3 <- topTreat(tfit.I5, coef = 3, n = Inf)
results3 <- mutate(tmp3, sig=ifelse(tmp3$adj.P.Val<0.1, "Sig", "Not Sig"))
p3 <- ggplot(results3, aes(logFC, -log10(P.Value))) +
  geom_point(aes(col = sig)) +
  scale_color_manual(values=c("black", "red")) +
  ggtitle("Low vs. High shedding") +
  ylab("-Log10(p-value)") +
  xlab("Log(Fold count)") +
  theme_bw() +
  theme(legend.position = "none")

grid.arrange(p1, p2, p3, nrow = 1)
```


$## Heatmap
$```{r, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 9, fig.align = "center"}
$# Get the gene names for DE genes
$lcpm2 <- as_tibble(dge.I5$counts) %>% 
$  cpm(., log = TRUE) %>% 
$  as_tibble() %>% 
$  mutate(ensembl_gene_id = dge.I5$genes$ensembl_gene_id)
$
$colOrder <- covars.I5 %>% 
$  select(SSgroup.virus.avg, group, bird) %>% 
$  mutate(SSgroup.virus.avg = fct_relevel(SSgroup.virus.avg, "LOW", "MODERATE", "HIGH")) %>%
$  arrange(SSgroup.virus.avg, group, bird) %>% 
$  unite("newNames", SSgroup.virus.avg, group, bird)
$
$colnames(lcpm2) <- newNames$newNames
$lcpm2 <- lcpm2[, colOrder$newNames]
$
$heatmap.annot <- annot %>%
$  filter(ensembl_gene_id %in% dt.tib$gene) %>% 
$  distinct(ensembl_gene_id, .keep_all = TRUE) %>% 
$  mutate(hgnc_symbol = replace_na(hgnc_symbol, ".")) %>% 
$  unite(annot.hm, c(ensembl_gene_id, hgnc_symbol), sep = "-", remove = FALSE) %>% 
$  select(annot.hm, ensembl_gene_id)
$
$deGeneCounts <- lcpm2 %>% 
$  as_tibble() %>% 
$  mutate(gene = rownames(.)) %>% 
$  rename(ensembl_gene_id = gene) %>% 
$  left_join(heatmap.annot) %>% 
$  column_to_rownames("annot.hm") %>%
$  select(-ensembl_gene_id) %>% 
$  as.matrix()
$
$deGeneCounts <- lcpm2 %>% 
$  as_tibble() %>% 
$  mutate(gene = rownames(dge$counts)) %>% 
$  filter(gene %in% dt.tib$gene) %>%
$  rename(gene_id = gene) %>% 
$  left_join(heatmap.annot) %>% 
$  mutate(SwissProt_GeneName = replace_na(SwissProt_GeneName, ".")) %>% 
$  unite(gene, gene_id:SwissProt_GeneName, sep = " - ") %>% 
$  column_to_rownames("gene") %>% 
$  as.matrix()
$
$## Set up palette
$mypalette <- brewer.pal(11,"RdYlBu")
$morecols <- colorRampPalette(mypalette)
$
$hc <- hclust(as.dist(1-cor(t(deGeneCounts))))
$
$# Plot the heatmap
$heatmap.2(deGeneCounts,
$          Colv = FALSE,
$          Rowv = as.dendrogram(hc),
$          col = rev(morecols(50)),
$          trace = "none",
$          colsep = c(5, 10),
$          dendrogram = "row",
$          density.info = "none",
$          key = TRUE,
$          #main = "Ileum - Gene level",
$          margins = c(10, 10),
$          scale ="row")
$```


### Annotations for differentially expressed genes
ns denotes non-significant genes for each comparison and numerical values are the log(fold count) difference
```{r message=FALSE, warning=FALSE, echo=FALSE}
tmp1a <- tmp1 %>% select(ensembl_gene_id, adj.P.Val, logFC, hgnc_symbol, description) %>% mutate(comp = "LvM")
tmp2a <- tmp2 %>% select(ensembl_gene_id, adj.P.Val, logFC, hgnc_symbol, description) %>% mutate(comp = "MvH")
tmp3a <- tmp3 %>% select(ensembl_gene_id, adj.P.Val, logFC, hgnc_symbol, description) %>% mutate(comp = "LvH")

bind_rows(tmp1a, tmp2a, tmp3a) %>% 
  select(-description) %>% 
  filter(ensembl_gene_id %in% dt.tib$gene) %>% 
  mutate(logFoldCount = ifelse(adj.P.Val < 0.10, round(logFC, 2), "ns")) %>% 
  select(-adj.P.Val, -logFC) %>% 
  pivot_wider(names_from = comp, values_from = logFoldCount) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

#### Gene functions
```{r message=FALSE, warning=FALSE}
bind_rows(tmp1a, tmp2a, tmp3a) %>% 
  select(-comp, -adj.P.Val, -logFC) %>% 
  filter(ensembl_gene_id %in% dt.tib$gene) %>% 
  distinct(.) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```


#### Pathway analysis
```{r message=FALSE, warning=FALSE}
de.entrez <- annot %>% filter(ensembl_gene_id %in% dt.tib$gene) %>% na.omit(entrezgene_id)
entrez.universe <- annot %>% na.omit(entrezgene_id)

K <- kegga(de.entrez$entrezgene_id, universe = entrez.universe$entrezgene_id, species.KEGG = "apla")
K %>% filter(P.DE < 0.05) %>% 
  arrange(P.DE) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

